name: o11y-canary
vars:
  vicmecHost: "http://localhost:8428"
testcases:
  - name: docker compose up
    steps:
      - type: exec
        script: docker compose up --build -d --wait --force-recreate

  - name: wait for services
    steps:
      - type: http
        url: "{{.vicmecHost}}/metrics"
        method: GET
        retries: 10
        delay: 2
        assertions:
          - result.statuscode ShouldEqual 200
      - type: http
        url: "http://localhost:8888/metrics"
        method: GET
        retries: 10
        delay: 2
        assertions:
          - result.statuscode ShouldEqual 200

  # try a few times but fail after 60s total
  - name: Check for metric write() existence
    steps:
      - type: exec
        script: |
          for i in $(seq 1 6); do
            out=$(curl -s -G http://localhost:8428/api/v1/query \
              -H "Content-Type: application/json" \
              --data-urlencode 'query=o11y_canary_canaried_metric_total{canary="true"}')
            echo "$out" | grep -q '"__name__":"o11y_canary_canaried_metric_total"' && echo "$out" && exit 0
            sleep 10
          done
          echo "Metric not found after 60s" >&2
          exit 1
        assertions:
          - result.code ShouldEqual 0
          - result.systemout ShouldContainSubstring '"status":"success"'
          - result.systemout ShouldContainSubstring "__name__":"o11y_canary_canaried_metric_total"
          - result.systemout ShouldContainSubstring "service.name":"my_canary_1"

  - name: Check for metric query() existence and that queries were successful
    steps:
      - type: exec
        script: |
          curl -s http://localhost:8080/metrics | grep -q '^o11y_canary_query_successes_total{.*} [1-9]'
        assertions:
          - result.code ShouldEqual 0

  - name: Check that total query count is incrementing
    steps:
      - type: exec
        script: |
          curl -s http://localhost:8080/metrics | grep -q '^o11y_canary_queries_total{.*} [1-9]'
        assertions:
          - result.code ShouldEqual 0

  - name: Check that failed queries are zero
    steps:
      - type: exec
        script: |
          curl -s http://localhost:8080/metrics | grep -q '^o11y_canary_query_errors_total{.*} 0'
        assertions:
          - result.code ShouldEqual 0

  - name: Check for o11y_canary_info in internal metrics
    steps:
      - type: exec
        script: |
          curl -s http://localhost:8080/metrics | grep -q '^o11y_canary_info{'
        assertions:
          - result.code ShouldEqual 0

  - name: clean up docker resources
    steps:
      - type: exec
        script: docker compose down --volumes --remove-orphans
